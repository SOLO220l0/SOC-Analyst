# شرح مفصّل — **How Routing Works** (كيف يعمل التوجيه)

رح أشرح لك خطوة بخطوة وبلغة عربية مبسطة مع مصطلحات إنجليزية بين قوسين عند الحاجة. بنقسم الشرح إلى: المبادئ، مكوّنات الراوتر، كيف يتخذ الراوتر قرار توجيه كل حزمة (packet)، أنواع التوجيه، والعناصر المتقدمة. خلّنا نبدأ.

---

## 1) الفكرة الأساسية (المفهوم)

**التوجيه (Routing)** هو عملية نقل حزم البيانات من شبكة إلى أخرى وصولاً إلى الوجهة النهائية. الراوترات تقرّر **المسار الأفضل** لكل حزمة بناءً على معلومات في جداول التوجيه (routing tables) وبروتوكولات التوجيه أو إعدادات ثابتة (static routes).

---

## 2) مقسمان رئيسيان: **Control Plane** و **Data Plane**

- **Control Plane (مستوى التحكم)**  
    مسؤول عن تعلم وبناء معلومات التوجيه — هنا تعمل بروتوكولات التوجيه (OSPF, BGP, EIGRP, RIP) أو يتم إدخال مسارات ثابتة. النتيجة: جدول التوجيه (RIB).
    
- **Data Plane (مستوى البيانات) / Forwarding Plane**  
    مسؤول عن **تنفيذ** قرارات التوجيه — استقبال الحزمة، البحث في جدول التوجيه/الفورواردينغ، وإرسال الحزمة للخارج. هذا المستوى يجب أن يكون سريعاً (hardware/ASICs أو CEF).
    

---

## 3) جداول مهمة داخل الراوتر

- **RIB (Routing Information Base)**: جدول يحتوي على كل المسارات التي تعلّمها الراوتر (من بروتوكولات، static، connected). هنا تُقيّم المسارات وفق الـ Administrative Distance و Metric.
    
- **FIB (Forwarding Information Base)**: نسخة مُبسطة/مُحسّنة من RIB تُستخدم فعلياً في عملية الفورواردينغ (بحث أسرع، تستخدمها CEF).
    
- **Adjacency Table / ARP Table**: تربط العنوان التالي (next-hop IP) إلى عنوان MAC والواجهة الفيزيائية.
    

---

## 4) كيف يتم توجيه حزمة خطوة-بخطوة (مثال تفصيلي)

مستخدم في شبكة A يريد إرسال حزمة إلى 8.8.8.8:

1. **مصدر يرسِل الحزمة** → الحزمة تصل إلى جهاز المصدر مع عنوان الوجهة (dst=8.8.8.8).
    
2. **التحقّق من الشبكة المحلية** (is dst on same subnet?)
    
    - إذا كانت على الشبكة نفسها يرسل مباشرة عبر ARP → MAC الوجهة.
        
    - عادة ليست على نفس الشبكة، فالمضيف يرسل الحزمة إلى **Default Gateway** (مثلاً 192.168.1.1).
        
3. **Router يستقبل الإطار** على واجهته (Layer-2)، يفك الإطار (decapsulation) ليصل إلى حزمة IP.
    
4. **التحقق من الـ TTL** (time-to-live): ينقص TTL بواحد — إذا وصل 0 يُرجع رسالة ICMP Time Exceeded.
    
5. **بحث في FIB / RIB**: الراوتر يبحث عن أفضل مسار إلى 8.8.8.8 — يستخدم مبدأ **Longest Prefix Match** (أطول تطابق قناع شبكي).
    
    - مثال: توجد مسارات 0.0.0.0/0 (default) و 8.8.8.0/24 → يختار 8.8.8.0/24 لأن قناعها أطول.
        
6. **تحديد next-hop** وواجهة الإرسال (e.g., next-hop = 10.0.0.2, exit-if = Gig0/0).
    
7. **تحويل next-hop IP إلى MAC**: يبحث في ARP أو يسأل ARP إذا غير موجود.
    
8. **إعادة تغليف الحزمة في إطار Layer-2 المناسب** وإرسالها على الواجهة الفعلية.
    
9. **الراوتر التالي يكرر نفس الإجراءات** حتى تصل الحزمة لِمُضيف الوجهة.
    

---

## 5) مفاهيم أساسية يجب معرفتها

### Longest Prefix Match

عندما يوجد أكثر من مدخل يُطابق عنوان الوجهة، الراوتر يختار الإدخال ذو **أطول قناع شبكي** (أكبر عدد بـ1s في القناع).

### Administrative Distance (AD)

مقياس ثقة للراوتر بأصل المسار (static أكثر ثقة من dynamic عادةً). مثال: AD لـــ static = 1، OSPF = 110، BGP (external) = 20.

### Metrics

قيمة تستخدمها بروتوكولات التوجيه لتحديد أفضل مسار (مثل cost في OSPF، AS-path/LocalPref في BGP، hop count في RIP).

### Recursion (Recursive Lookup)

المسار قد يشير إلى next-hop ليس مباشرة على شبكة الراوتر؛ فالراوتر قد يحتاج للبحث مجدداً لمعرفة واجهة الارسال الحقيقية.

### ARP (Address Resolution Protocol)

لربط IP ↔ MAC على نفس الشبكة. توضيح عملي: قبل إرسال إطار يجب معرفة MAC الوجهة للـ next-hop.

---

## 6) أنواع التوجيه (طرق الحصول على المسارات)

- **Connected**: الشبكات المتصلة مباشرة بالواجهات (أعلى أولوية تلقائياً).
    
- **Static Routes**: مسارات تُدخل يدوياً `ip route ...`.
    
- **Dynamic Routing Protocols**:
    
    - **RIP**: قديم، يعتمد hop count، محدود لـ15 hops.
        
    - **OSPF**: Link-state، يوزّع LSA ويبني خريطة الشبكة (topology) ثم يشغّل Dijkstra.
        
    - **EIGRP**: Hybrid (Cisco)، يوازن بين السرعة والدقة، يستخدم metrics مركبة.
        
    - **BGP**: نظام توجيه بين الـ ASes على الإنترنت؛ يحدد سياسات، يستخدم attributes عديدة (AS-path, localpref).
        
- **Policy-Based Routing (PBR)**: توجيه بناءً على سياسات (مصدر، نوع بروتوكول، الـ DSCP) بدلاً من الوجهة فقط.
    

---

## 7) بروتوكولات التوجيه — نظرة مختصرة على عملها

### Link-State Protocols (مثل OSPF)

- كل راوتر يبني خريطة كاملة للشبكة (LSDB) عبر تبادل LSAs.
    
- يستخدم خوارزمية **Dijkstra** ليبني Shortest Path Tree ويملأ جدول التوجيه.
    
- ميزة: تقارب (convergence) سريع، معرفة كاملة للـ topology.
    

### Distance-Vector Protocols (مثل RIP)

- كل راوتر يرسل جدول مساراته إلى جيرانه دورياً.
    
- يعتمد على تقاطع المسافات (hop counts) — مشكلة: count-to-infinity، بطيء في convergence.
    

### Path-Vector (BGP)

- يعلن المسارات مع سلسلة الـ AS path ويُستخدم للسياسة والتحكم على مستوى الإنترنت.
    

---

## 8) الأداء: Hardware vs Software forwarding

- راوترات حديثة تستخدم **CEF (Cisco Express Forwarding)** أو معالجات العتاد (ASICs) لتسريع عملية الفورواردينغ بعيداً عن الـ CPU.
    
- الـ Control Plane يظل يعمل على CPU لبناء الجداول بينما الـ Data Plane يمرّر الحزم بسرعة عالية.
    

---

## 9) قضايا متقدمة ومهمّة لمهندسي الشبكات

- **Convergence**: زمن استقرار الشبكة بعد تغير (فشل رابط). أسرع في Link-state عموماً.
    
- **Route Redistribution**: نقل مسارات بين بروتوكولات (مثلاً OSPF ↔ BGP) — يتطلب سياسات لتجنب loops.
    
- **Route Summarization**: تلخيص شبكات لتقليل حجم جدول التوجيه (مثلاً 10.0.0.0/8 بدلاً من كثير من /24).
    
- **Load Balancing**: توزيع المرور عبر مسارات متعددة (ECMP: Equal-Cost Multi-Path).
    
- **VRF (Virtual Routing and Forwarding)**: عزل جداول توجيه متعددة على نفس الراوتر (مثل محتوى MVN).
    
- **Security**: استخدام ACLs، RPKI/BGP prefix filtering، ومصادقة لمجمعات التوجيه (MD5/auth) لحماية البروتوكولات.
    

---

## 10) مثال عملي مبسّط (مثال routing table)

```
Gateway of last resort is 192.0.2.1 to network 0.0.0.0

S* 0.0.0.0/0 [1/0] via 192.0.2.1
C 10.10.10.0/24 is directly connected, Gig0/1
O 172.16.0.0/16 [110/20] via 10.0.0.2, 00:01:23, Gig0/0
B 198.51.100.0/24 from 65001 (via 203.0.113.2)
```

- `S*` = static default route
    
- `C` = connected
    
- `O` = learned via OSPF
    
- `B` = learned via BGP
    

عند ورود حزمة لوجهة 172.16.5.10 → الراوتر سيختار السطر `O 172.16.0.0/16` لأنها تطابق طويل ومناسبة، ثم يرسِل للحلقة التالية عبر `10.0.0.2`.

---

## 11) نصائح عملية وملاحظات سريعة

- راقب **الـ routing table** و **ARP table** عند تشخيص مشاكل الاتصال.
    
- تأكد من **عدم وجود شبكات متداخلة** (overlapping subnets).
    
- استعمل **summarization** و **default routes** بذكاء لتقليل جدول التوجيه.
    
- علّم نفسك استخدام أوامر تشخيصية: `show ip route`, `show ip cef`, `show ip arp`, `traceroute`, `ping`, `debug ip routing` (بحذر).
    
- في بيئة الإنترنت، اهتم بسياسات BGP وفلترة المسارات لمنع hijacks.
    

---

إذا حاب أكمّل: أقدر أخلي الشرح أكثر عملية — أعمل سيناريو شبكة واقعي (مثال: فرع-مقر-إنترنت) وأعطيك:

- التكوينات (Cisco IOS) للراوترات،
    
- أظهر كيف OSPF وBGP يتعاملون مع المسارات،
    
- أو نشرح خطوة-بخطوة عملية convergence عند قطع رابط.
    

وش تفضّل؟


[[69- Static Host Route]]